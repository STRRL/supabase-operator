# Final Design Decisions - Supabase Operator

## Confirmed Architecture Decisions

### 1. Configuration Management
**Decision**: ALL configuration stored in Kubernetes Secrets
- **Database**: Connection details fully in secret (host, port, database, username, password)
- **Storage**: S3 configuration fully in secret (endpoint, region, bucket, accessKeyId, secretAccessKey)
- **Rationale**: Maximum security, no sensitive or connection data exposed in CRD spec
- **Trade-off Accepted**: Less discoverable configuration, requires viewing secrets for debugging

### 2. Image Tag Management
**Decision**: Container image tags are part of SupabaseProjectSpec
- Each component has an `Image` field in its config (e.g., `kong.image`)
- Defaults hardcoded with kubebuilder annotations
- Current defaults from upstream (2025-10-03):
  - Kong: `kong:2.8.1`
  - GoTrue: `supabase/gotrue:v2.177.0`
  - PostgREST: `postgrest/postgrest:v12.2.12`
  - Realtime: `supabase/realtime:v2.34.47`
  - Storage API: `supabase/storage-api:v1.25.7`
  - Meta: `supabase/postgres-meta:v0.91.0`
- **Update Strategy**: Manual CRD updates when new versions released

### 3. Resource Requirements
**Decision**: Controller applies hardcoded defaults when Resources is nil
- Defaults documented in code and operator documentation
- Not using namespace LimitRanges for operator defaults
- **Default Values**:
  ```yaml
  Kong: 2.5GB memory, 500m CPU
  Realtime: 256MB memory, 200m CPU
  PostgREST: 256MB memory, 200m CPU
  Auth/GoTrue: 128MB memory, 100m CPU
  Storage API: 128MB memory, 100m CPU
  Meta: 128MB memory, 100m CPU
  ```

### 4. Error Handling
**Decision**: No automatic rollback on failures
- Keep failed state for manual investigation (案发现场)
- Reconciliation loop handles retries
- Aligns with Kubernetes controller patterns

### 5. Secret Key Conventions
**Decision**: Fixed key names, validated in controller/webhook

**Database Secret Keys**:
- `host`: PostgreSQL host (required)
- `port`: PostgreSQL port (required)
- `database`: Database name (required)
- `username`: Database username (required)
- `password`: Database password (required)

**Storage Secret Keys**:
- `endpoint`: S3-compatible endpoint URL (required)
- `region`: Storage region (required)
- `bucket`: Bucket name (required)
- `accessKeyId`: Access key ID (required)
- `secretAccessKey`: Secret access key (required)

### 6. Type Usage
**Decision**: Use standard Kubernetes types wherever possible
- `corev1.SecretReference` for all secret references
- `corev1.ResourceRequirements` for resource limits/requests
- `corev1.EnvVar` for environment variables
- `metav1.Condition` for status conditions

### 7. CRD Generation
**Decision**: CRD YAML generated by Kubebuilder from Go types
- The `contracts/supabaseproject-crd.yaml` is reference only
- Actual CRD generated via `make manifests`
- OpenAPI schema derived from kubebuilder markers

## Implementation Guidelines

### Controller Responsibilities
1. Validate secret existence and required keys
2. Apply resource defaults when not specified
3. Manage component deployment order
4. Track per-component status and phases
5. Emit events for significant state changes
6. No automatic rollback - maintain failed state

### Webhook Responsibilities
1. Validate secret references exist
2. Validate required secret keys present
3. Cross-field validation
4. Image reference validation
5. Resource requirement validation

### Status Management
- 15+ granular conditions (standard + component-specific + dependency)
- Per-component phase tracking
- Component versions in status
- Service endpoints exposed
- Dependency connection status

## Next Steps
1. Generate tasks with `/tasks` command
2. Implement CRD types with kubebuilder markers
3. Create controller with resource defaulting logic
4. Implement secret validation in webhook
5. Write integration tests with envtest